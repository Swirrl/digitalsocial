<script>
  $(function() {

    DSIMap = {

      map: null,
      clusters: null,
      allOrganisations: {},
      visibleOrganisations: {},
      currentMaxLineCount: 0,
      networkViewMarker: null,
      
      currentFilters: <%= params[:filters].to_json.html_safe %>,
      clusterLevel: $('input#cluster-level').val(),

      defaultCenter: [49, 12],
      defaultZoom: 5,
      minLineWeight: 1,
      maxLineWeight: 5,
      minLineOpacity: 0.1,
      maxLineOpacity: 0.4,
      maxClusterRadius: 80,
      disableClusteringAtZoom: 20,
      layerWithoutLabels: L.mapbox.tileLayer("<%= Digitalsocial::MAPBOX_TEST_3 %>"),
      layerWithLabels: L.mapbox.tileLayer("<%= Digitalsocial::MAPBOX_TEST_3 %>"),
      maxClusterChildCount: 40,

      clusterConfig: [{
          // Level 0
          disableClusteringAtZoom: 1, // 1 = no clustering
          maxLineWeight: 1.5,
          maxLineOpacity: 0.2
        }, {
          // Level 1
          disableClusteringAtZoom: 20,
          maxLineWeight: 5,
          maxLineOpacity: 0.4,
          maxClusterRadius: 20
        }, {
          // Level 2
          disableClusteringAtZoom: 20,
          maxLineWeight: 5,
          maxLineOpacity: 0.4,
          maxClusterRadius: 30
        }, {
          // Level 3
          disableClusteringAtZoom: 20,
          maxLineWeight: 5,
          maxLineOpacity: 0.4,
          maxClusterRadius: 50
        }, {
          // Level 4
          disableClusteringAtZoom: 20,
          maxLineWeight: 5,
          maxLineOpacity: 0.4,
          maxClusterRadius: 80
        }
      ],

      init: function() {
        this.initMap();
        this.bindMapEvents();

        this.initClusters();
        this.initFilter();

        if (this.currentFilters) {
          this.fetchFilterOrganisations();
        }

        this.fetchOrganisations();
      },

      initMap: function() {
        map = L.map('home-map', {
          scrollWheelZoom: true
        })
        .setView(DSIMap.defaultCenter, DSIMap.defaultZoom)
        .addLayer(DSIMap.layerWithoutLabels);

        map._container.className = "leaflet-container leaflet-fade-anim cluster-level-" + DSIMap.clusterLevel;
      },

      initClusters: function() {
        DSIMap.clusterLevel = $('.filter #cluster-level').val();
        $.extend(DSIMap, DSIMap.clusterConfig[DSIMap.clusterLevel]);

        clusters = new L.MarkerClusterGroup({
          showCoverageOnHover: false,
          removeOutsideVisibleBounds: false,
          zoomToBoundsOnClick: false,
          maxClusterRadius: DSIMap.maxClusterRadius,
          disableClusteringAtZoom: DSIMap.disableClusteringAtZoom,
          iconCreateFunction: function(cluster) {
            var childCount = cluster.getChildCount();

            var c = ' marker-cluster-';
            var iconSize;
            if (childCount < DSIMap.maxClusterChildCount / 10) {
              c += 'x-small';
              iconSize = 16;
            } else if (childCount < DSIMap.maxClusterChildCount / 5) {
              c += 'small';
              iconSize = 20;
            } else if (childCount < DSIMap.maxClusterChildCount / 2.5) {
              c += 'medium';
              iconSize = 26;
            } else if (childCount < DSIMap.maxClusterChildCount) {
              c += 'large';
              iconSize = 36;
            } else {
              c += 'x-large';
              iconSize = 48;
            }

            return new L.DivIcon({
              html: '<div><span>' + childCount + '</span></div>',
              className: 'marker-cluster' + c,
              iconSize: new L.Point(iconSize, iconSize)
            });
          }
        });

        this.bindClusterEvents();

      },

      initFilter: function() {
        this.bindFilterEvents();
      },

      bindFilterEvents: function() {
        $('.filter a.title').click(function(e){
          $(this).parents('.filter-section').toggleClass('expanded');
          e.preventDefault();
        });

        $('.filter .option input').change(function(e){
          $('.filter .filter-button').removeAttr('disabled');
        });

        $('.filter .filter-section a.reset').click(function(e){
          $(this).parents('.filter-section').find('.option input').attr('checked', false);
          $('.filter form').submit();

          e.preventDefault();
        });

        $("#slider" ).slider({
          value: DSIMap.clusterLevel,
          min: 0,
          max: 4,
          step: 1,
          slide: function(event, ui) {
            DSIMap.clusterLevel = ui.value;
            $('.filter #cluster-level').val(DSIMap.clusterLevel);

            map._container.className = "leaflet-container leaflet-fade-anim cluster-level-" + DSIMap.clusterLevel;
            
            clusters.clearLayers();
            DSIMap.clearLines();

            DSIMap.initClusters();
            DSIMap.addOrganisationPins();
            DSIMap.resizeClusters();
            DSIMap.addPartnerLines();
          }
        });
      },

      bindClusterEvents: function() {
        clusters.on('animationend', function(e){
          DSIMap.addVisibleLines();
          DSIMap.resizeClusters();
        });

        clusters.on('clustermouseover', function (a) {
          if(!DSIMap.networkViewMarker) DSIMap.highlightMarkerLines(a.layer);
        });

        clusters.on('clustermouseout', function (a) {
          if(!DSIMap.networkViewMarker) DSIMap.unhighlightMarkerLines(a.layer);
        });

        clusters.on('clusterclick', function (a) {
          a.layer.bindPopup('', {
            closeButton: false
          }).openPopup();
        });
      },

      bindMapEvents: function() {
        this.bindPopupOpen();
        this.bindZoomEnd();
        this.bindShowOrgNetworkClick();
        this.bindOrgZoomClick();
        this.bindResetMapClick();
        this.bindShowAllOrgsClick();
        this.bindZoomClusterClick();

        map.on('zoomstart', function(e){
          DSIMap.clearLines();
        });

        // IE9 and below do not fire animation end
        if($.browser.msie && $.browser.version <= 9) {
          map.on('zoomend', function(e){
            setTimeout(DSIMap.addVisibleLines, 1000);
          });
        }

        $('.show-more a').click(function(e){
          DSIMap.slideInPanels();
          e.preventDefault();
          return false;
        });

        $('a.hide-info').click(function(e) {
          e.preventDefault();
          DSIMap.slideOutPanels();
          return false;
        });

        $('a.hide-info-mobile').click(function(e) {
          e.preventDefault();
          DSIMap.hideMobilePanels();
          return false;
        });

        $('a.show-info-mobile').click(function(e) {
          e.preventDefault();
          DSIMap.showMobilePanels();
          return false;
        });

        $('.show-filter a').click(function(e) {
          e.preventDefault();
          DSIMap.slideOutPanels();
          return false;
        });
      },

      bindPopupOpen: function(e) {
        map.on('popupopen', function(e) {
          if (e.popup._source._guid) {
            DSIMap.fetchPinPopupContent(e);
          } else if (e.popup._source._childCount) {
            DSIMap.fetchClusterPopupContent(e);
          }
        });
      },

      bindZoomEnd: function(e) {
        map.on('zoomend', function(e){
          if (e.target._zoom > 6) {
            map.removeLayer(DSIMap.layerWithoutLabels);
            map.addLayer(DSIMap.layerWithLabels);
          } else {
            map.removeLayer(DSIMap.layerWithLabels);
            map.addLayer(DSIMap.layerWithoutLabels);
          }
        });
      },

      bindShowOrgNetworkClick: function(e) {
        $(document.body).on('click', 'a.show-org-network', function(e) {

          clusters.clearLayers();
          DSIMap.clearLines();

          var guid = e.target.hash.substring(1);
          var markerLatLng = DSIMap.allOrganisations[guid].marker._latlng;
          DSIMap.visibleOrganisations = {};

          if (DSIMap.networkViewMarker) {
            DSIMap.highlightMarker(visibleMarker);
          }

          DSIMap.networkViewMarker = DSIMap.allOrganisations[guid].marker;

          var partnerLatLngs = [];

          $.each(DSIMap.allOrganisations[guid].partners, function(i, partnerGuid) {
            DSIMap.visibleOrganisations[partnerGuid] = DSIMap.allOrganisations[partnerGuid];
            partnerLatLngs.push(DSIMap.allOrganisations[partnerGuid].marker._latlng);
          });

          $('.active-organisation .name').text(DSIMap.allOrganisations[guid].name);
          $('.active-organisation').css({ top: 0 });
          $('.filter').css({ top: "-800px" });

          DSIMap.visibleOrganisations[guid] = DSIMap.allOrganisations[guid];
          DSIMap.addOrganisationPins();
          DSIMap.addPartnerLines();

          var networkLatLngs = partnerLatLngs;
          networkLatLngs.push(markerLatLng);
          var bounds = new L.LatLngBounds(networkLatLngs);
          map.fitBounds(bounds);

          var visibleMarker = clusters.getVisibleParent(DSIMap.networkViewMarker);

          DSIMap.highlightMarkerLines(visibleMarker);
          DSIMap.highlightMarker(visibleMarker);

          e.preventDefault();
          return false;
        });
      },

      bindOrgZoomClick: function(e) {
        $(document.body).on('click', 'a.org-zoom', function(e) {
          var guid = e.target.hash.substring(1);
          var marker = DSIMap.allOrganisations[guid].marker;

          clusters.zoomToShowLayer(marker, function(){
            marker.openPopup();
          });
          
          e.preventDefault();
          return false;
        });
      },

      bindShowAllOrgsClick: function(e) {
        $(document.body).on('click', '.show-all-orgs a', function(e) {
          $(this).parents('.leaflet-popup-content').find('.organisations li').show();
          $(this).hide();
          e.preventDefault();
        });
      },

      bindResetMapClick: function() {
        $('a.reset-map').click(function(e){
          DSIMap.networkViewMarker.setIcon(new L.DivIcon({
            iconSize: new L.Point(10, 10)
          }));
          DSIMap.networkViewMarker = null;
          DSIMap.visibleOrganisations = DSIMap.allOrganisations;

          map.setZoom(DSIMap.defaultZoom);

          clusters.clearLayers();
          DSIMap.clearLines();

          DSIMap.addOrganisationPins();
          DSIMap.addPartnerLines();
          DSIMap.resizeClusters();

          var top = $('.active-organisation').height() + 30;
          $('.active-organisation').css({ top: '-'+top+'px' });
          $('.filter').css({ top: "0" });

          e.preventDefault();
          return false;
        });

      },

      bindZoomClusterClick: function() {
        $(document.body).on('click', 'a.zoom-cluster', function(e) {
          var popup_id = $(this).data('cluster-id');
          map._layers[popup_id].zoomToBounds();
          e.preventDefault();
        });
      },

      fetchOrganisations: function(e) {
        $.ajax({
          type: 'GET',
          url: '/organisations/map_index',
          data: {
            filters: DSIMap.currentFilters
          },
          success: function(data){
            DSIMap.setAllOrganisations(data.organisations);
            DSIMap.visibleOrganisations = DSIMap.allOrganisations;
            DSIMap.addOrganisationPins();
            DSIMap.resizeClusters();

            DSIMap.fetchPartners();
          },
          dataType: 'json'
        });
      },

      fetchFilterOrganisations: function(e) {
        $.ajax({
          type: 'GET',
          url: '/organisations/map_index',
          success: function(data){
            DSIMap.addFilterOrganisationPins(data.organisations);
          },
          dataType: 'json'
        });
      },

      setAllOrganisations: function(organisations) {
        $.each(organisations, function(i, organisation) {
          DSIMap.allOrganisations[organisation.guid] = {};
          DSIMap.allOrganisations[organisation.guid].name = organisation.name;
          DSIMap.allOrganisations[organisation.guid].marker = DSIMap.buildOrganisationPin(organisation);
          DSIMap.allOrganisations[organisation.guid].partners = [];
        });
      },

      addVisibleLines: function() {
        DSIMap.addPartnerLines(DSIMap.allOrganisations);

        if (DSIMap.networkViewMarker) {
          var visibleMarker = clusters.getVisibleParent(DSIMap.networkViewMarker);

          DSIMap.highlightMarkerLines(visibleMarker);
          DSIMap.highlightMarker(visibleMarker);
        }
      },

      resizeClusters: function() {
        DSIMap.maxClusterChildCount = 0;
        $.each(clusters._featureGroup._layers, function(i, e){
          if (e._childCount && e._childCount > DSIMap.maxClusterChildCount) {
            DSIMap.maxClusterChildCount = e._childCount;
          }
        });

        $.each(clusters._featureGroup._layers, function(i, e){
          var childCount = e._childCount;
          if (childCount){
            var c = ' marker-cluster-';
            var iconSize;
            if (childCount < DSIMap.maxClusterChildCount / 10) {
              c += 'x-small';
              iconSize = 16;
            } else if (childCount < DSIMap.maxClusterChildCount / 5) {
              c += 'small';
              iconSize = 20;
            } else if (childCount < DSIMap.maxClusterChildCount / 2.5) {
              c += 'medium';
              iconSize = 26;
            } else if (childCount < DSIMap.maxClusterChildCount) {
              c += 'large';
              iconSize = 36;
            } else {
              c += 'x-large';
              iconSize = 48;
            }

            e.setIcon(new L.DivIcon({
              html: '<div><span>' + childCount + '</span></div>',
              className: 'marker-cluster' + c,
              iconSize: new L.Point(iconSize, iconSize)
            }));
          }
        });

      },

      addOrganisationPins: function() {
        map.removeLayer(clusters);
        clusters.clearLayers();

        $.each(DSIMap.visibleOrganisations, function(guid, organisation) {
          clusters.addLayer(DSIMap.allOrganisations[guid].marker);
        });

        map.addLayer(clusters);
      },

      buildOrganisationPin: function(organisation) {
        var marker = L.marker(new L.LatLng(organisation.lat, organisation.lng), {
          icon: new L.DivIcon({
            iconSize: new L.Point(10, 10)
          })
        })
        .bindPopup('', {
          closeButton: false
        }).on('mouseover', function(mkr){
          if (!DSIMap.networkViewMarker) {
            DSIMap.highlightMarkerLines(this);
          }
        }).on('mouseout', function(mkr){
          if (!DSIMap.networkViewMarker) {
            DSIMap.unhighlightMarkerLines(this);
          }
        });

        marker._guid = organisation.guid;

        return marker;
      },

      addFilterOrganisationPins: function(organisations) {
        $.each(organisations, function(i, organisation){
          var marker = L.marker(new L.LatLng(organisation.lat, organisation.lng), {
            icon: new L.DivIcon({
              iconSize: new L.Point(10, 10),
              className: 'leaflet-div-icon faded'
            })
          });
          marker.addTo(map);
        });
      },

      fetchPinPopupContent: function(e) {
        var guid = e.popup._source._guid;

        $.ajax({
          type: 'GET',
          url: '/organisations/'+guid+'/map_show',
          beforeSend: function(){
            e.popup.setContent('<div class="spinner"></div>');
          },
          success: function(data){
            DSIMap.setPinPopupContent(data.organisation, e.popup);
          },
          error: function() {
            e.popup.setContent('<div class="popup-error">Oops - something went wrong.</div>');
          },
          dataType: 'json'
        });

        if (this.isMobile()) {
          this.hideMobilePanels();
        } else {
          this.slideOutPanels();
        }
      },

      setPinPopupContent: function(organisation, popup) {
        var content = '';
        content += '<h3><a href="/organisations/'+organisation.guid+'">'+organisation.name+'</a></h3>';

        if (organisation.address) {
          content += '<p class="address">'+organisation.address+'</p>';
        }

        if (organisation.projects.length > 0) {
          content += '<ul class="projects">';
          $.each(organisation.projects, function(i, project) {
            content += '<li><a href="/projects/'+project.guid+'">'+project.name+'</a></li>';
          });
          content += '</ul>';
        }

        if (DSIMap.allOrganisations[organisation.guid].partners.length) {
          content += '<div class="divider"></div>';
          content += '<div class="actions"><a href="#'+organisation.guid+'" class="show-org-network">Show this organisation\'s network</a></div>';
        }

        popup.setContent(content);
      },

      fetchClusterPopupContent: function(e) {
        var guids = [];

        $.each(e.popup._source.getAllChildMarkers(), function(i, marker){
          guids.push(marker._guid);
        });

        $.ajax({
          type: 'POST',
          url: '/organisations/map_cluster',
          data: {
            guids: guids
          },
          beforeSend: function(){
            e.popup.setContent('<div class="spinner"></div>');
          },
          success: function(data){
            DSIMap.setClusterPopupContent(data.organisations, e.popup);
          },
          error: function() {
            e.popup.setContent('<div class="popup-error">Oops - something went wrong.</div>');
          },
          dataType: 'json'
        });

        if (this.isMobile()) {
          this.hideMobilePanels();
        } else {
          this.slideOutPanels();
        }
      },

      setClusterPopupContent: function(organisations, popup) {
        var content = '';

        content += '<ul class="organisations">';
        $.each(organisations, function(i, organisation) {
          content += '<li><a class="org-zoom" href="#'+organisation.guid+'">'+organisation.name+'</a></>';
        });
        content += '</ul>';

        content += '<div class="divider"></div>';
        content += '<div class="actions"><a href="#" data-cluster-id="'+popup._source._leaflet_id+'" class="zoom-cluster">Zoom in</a></div>';

        popup.setContent(content);
      },

      isMobile: function() {
        var mobile = false;
        if( window.matchMedia && window.matchMedia( "(max-width: 767px)" ).matches) {
          mobile = true;
        }
        return mobile;
      },

      slideOutPanels: function() {
        $('.logo').css({ top: "-154px" });
        $('.info').css({ left: "-898px" });
        $('.show-filter').css({ top: "-60px" });

        setTimeout(function(){
          $('.info').hide();
          $('.small-info').fadeIn();
          $('.filter').css({ top: "0" });
        }, 500);
      },

      slideInPanels: function() {
        $('.info').show();
        $('.small-info').fadeOut();
        $('.filter').css({ top: "-936px" });

        setTimeout(function(){
          $('.info').css({ left: "0" });
          $('.logo').css({ top: "0" });
          $('.show-filter').css({ top: "0" });
        }, 250);
      },

      showMobilePanels: function() {
        $('.mobile-info').show();
        $('.mobile-small-info').hide();
      },

      hideMobilePanels: function() {
        $('.mobile-info').hide();
        $('.mobile-small-info').show();
      },

      clearLines: function() {
        DSIMap.currentMaxLineCount = 0;

        for (i in map._layers) {
          if (map._layers[i]._path != undefined) {
            try {
              map.removeLayer(map._layers[i]);
            }
            catch(e){
              console.log("problem with " + e + map._layers[i]);
            }
          }
        }
      },

      fetchPartners: function() {
        $.ajax({
          type: 'GET',
          url: '/organisations/map_partners',
          data: {
            filters: DSIMap.currentFilters
          },
          //url: '/organisations/map_partners_static',
          success: function(data){
            DSIMap.setAllOrganisationPartners(data.organisations);
            DSIMap.addPartnerLines(DSIMap.allOrganisations);
          },
          dataType: 'json'
        });
      },

      setAllOrganisationPartners: function(organisations) {
        $.each(organisations, function(guid, partners) {
          DSIMap.allOrganisations[guid].partners = partners;
        });
      },

      addPartnerLines: function(organisations) {
        DSIMap.clearLines();

        var lines = this.buildPartnerLines(organisations);

        $.each(lines, function(i, line){
          var newLine = DSIMap.drawLine(line.markerA, line.markerB, line.count);
          DSIMap.addLineToMarker(line.markerA, newLine);
          DSIMap.addLineToMarker(line.markerB, newLine);
        });
      },

      drawLine: function(markerA, markerB, count) {

        var line = new L.Polyline([markerA._latlng, markerB._latlng], {
          color: '#777',
          weight: DSIMap.lineWeightForCount(count),
          opacity: DSIMap.lineOpacityForCount(count),
          smoothFactor: 1,
          clickable: false
        }).addTo(map);

        return line;
      },

      lineWeightForCount: function(count) {
        var max = DSIMap.currentMaxLineCount;
        if (max <= 1 && DSIMap.clusterLevel != 0) max = 2;

        var ratio = (count / max);
        var difference = DSIMap.maxLineWeight - DSIMap.minLineWeight;

        return DSIMap.minLineWeight + (ratio * difference);
      },

      lineOpacityForCount: function(count) {
        var max = DSIMap.currentMaxLineCount;
        if (max <= 1 && DSIMap.clusterLevel != 0) max = 2;

        var ratio = (count / max);
        var difference = DSIMap.maxLineOpacity - DSIMap.minLineOpacity;

        return DSIMap.minLineOpacity + (ratio * difference);
      },

      buildPartnerLines: function() {
        var lines = {};

        $.each(DSIMap.visibleOrganisations, function(orgGuid, org){

          // Loop through each of the org's partners
          $.each(org.partners, function(i, partnerGuid){

            if (DSIMap.visibleOrganisations[partnerGuid]) {

              visibleMarkerA = clusters.getVisibleParent(org.marker);
              visibleMarkerB = clusters.getVisibleParent(DSIMap.allOrganisations[partnerGuid].marker);

              if (visibleMarkerA._latlng == visibleMarkerB._latlng) return true;

              var visibleMarkers = [visibleMarkerA._latlng, visibleMarkerB._latlng];

              // If we have already set a line for this combination of markers increase the count (weight)
              if (lines[visibleMarkers]) {
                lines[visibleMarkers].count += 1;
              }
              // Else initialise it
              else {
                lines[visibleMarkers] = {};
                lines[visibleMarkers].count = 1;
                lines[visibleMarkers].markerA = visibleMarkerA;
                lines[visibleMarkers].markerB = visibleMarkerB;
              }

              if (lines[visibleMarkers].count > DSIMap.currentMaxLineCount) {
                DSIMap.currentMaxLineCount = lines[visibleMarkers].count;
              }
            }

          });

        });

        return lines;
      },

      addLineToMarker: function(marker, line) {
        if (!marker._lines) marker._lines = [];
        marker._lines.push(line);
      },

      highlightMarker: function(marker) {
        marker._icon.className = marker._icon.className + ' hover';
      },

      highlightMarkerLines: function(marker) {
        if (!marker._lines) return false;

        $.each(marker._lines, function(i, line) {
          line.setStyle({ color: '#F39200' });
        });
      },

      unhighlightMarkerLines: function(marker) {
        if (!marker._lines) return false;

        $.each(marker._lines, function(i, line) {
          line.setStyle({ color: '#777' });
        });
      }
    }

    DSIMap.init();


  });

</script>